# ゲーム理論シミュレーションプロジェクト開発ガイドライン

## 1. プロジェクト概要

このプロジェクトは、ゲーム理論の概念（ナッシュ均衡、ムカデゲームなど）をシミュレーションするためのWebアプリケーションです。Laravel（PHP）をバックエンドに、JavaScript/TypeScriptをフロントエンドに使用しています。

## 2. サーバーサイド開発ガイドライン

### 2.1 App\Calculations クラス

App\Calculations ディレクトリには、ゲーム理論の計算を行うクラスが含まれています。現在、以下のクラスが実装されています：

#### 2.1.1 Nash クラス

Nash クラスは、ナッシュ均衡の計算を行います。主な特徴：

- 分数計算に `Phospr\Fraction` ライブラリを使用
- 主要メソッド：
  - `run()`: 計算のエントリーポイント
  - `calcGamma1X()`: ガンマ1のX座標を計算
  - `calcGamma2Y()`: ガンマ2のY座標を計算
  - `calcMidpoint()`: 中点を計算
  - `calcARho()`: a_rho値を計算
  - `getDisplayText()`: 表示用テキストを生成

#### 2.1.2 Centipede クラス

Centipede クラスは、ムカデゲームのシミュレーションを行います。主な特徴：

- 複雑な数学的計算を `eval()` を使用して実行
- 主要メソッド：
  - `run()`: 複数パターンの計算を実行
  - `calculatePattern()`: 特定パターンの計算を実行
  - `unionCalculateData()`: 2つのプレイヤーのシミュレーション結果を合算
  - `calcCognitiveUnitValue()`: 認知単位の値を計算
  - `makeCognitiveUnitLatexText()`: LaTeX形式のテキストを生成
  - `makeChartData()`: チャート表示用データを生成

### 2.2 分数計算の実装

計算クラスでは、精度を保つために分数計算を多用しています：

- `Phospr\Fraction` ライブラリを使用して分数を表現
- 分数の加減乗除は、対応するメソッド（`add()`, `subtract()`, `multiply()`, `divide()`）を使用
- 分数から浮動小数点数への変換は `toFloat()` メソッドを使用
- 分子と分母の取得には `getNumerator()` と `getDenominator()` メソッドを使用

### 2.3 PHPユニットテスト

PHPのユニットテストは、以下の方針で実装しています：

- `tests/Unit` ディレクトリにテストクラスを配置
- 計算クラスのテスト（例：`NashTest`, `CentipedeTest`）では：
  - privateメソッドのテストには `ReflectionClass` を使用
  - 複数のテストケースをデータプロバイダーで提供
  - 分数の計算結果は分子と分母の両方を検証
- リクエストバリデーションのテスト（例：`CalculateNashRequestTest`, `CalculateCentipedeRequestTest`）では：
  - `authorize()` メソッドのテスト
  - バリデーションルールの存在と内容の検証
  - 有効なデータと無効なデータの両方でのバリデーション検証
  - カスタムバリデーションルール（`FractionMax`, `Coordinate`など）のテスト

## 3. フロントエンド開発ガイドライン

### 3.1 TypeScriptへの移行

現在、JavaScriptからTypeScriptへの移行を進めています：

- 新規コードはTypeScriptで記述
- 既存のJavaScriptコードは段階的にTypeScriptに移行中
- `tsconfig.json` で型チェックの設定を管理

#### 3.1.1 TypeScript実装例（nash.ts）

- 型定義を使用した関数宣言（例：`function reset(): void`）
- ES6モジュールインポート構文の使用
- イベントハンドラの実装

#### 3.1.2 JavaScript実装例（centipede.js）

- CommonJSスタイルの `require()` を使用したモジュールインポート
- jQueryを使用したDOM操作とイベントハンドリング
- ブラウザ検出とチャートダウンロード機能

### 3.2 フロントエンド共通ガイドライン

- KaTeXライブラリを使用して数式を表示
- チャート表示には適切なライブラリを使用
- フォーム入力値のリセット機能を実装
- 計算中はスピナーを表示

## 4. 開発プロセス

### 4.1 新機能の追加

1. サーバーサイドの計算クラスを `App\Calculations` に実装
2. 対応するユニットテストを `tests/Unit/Calculations` に実装
3. リクエストバリデーションクラスを作成し、テストを実装
4. フロントエンドのTypeScriptコードを実装

### 4.2 既存機能の修正

1. 該当するテストを確認または追加
2. サーバーサイドコードを修正
3. フロントエンドコードを修正
4. テストを実行して変更を検証

## 5. 注意事項

- 分数計算の実装は複雑なため、コメントを詳細に記述し、テストで十分に検証してください
- 数学的な計算式は、可能な限り定数として定義し、コメントで説明を追加してください
- JavaScriptからTypeScriptへの移行は慎重に行い、既存の機能を損なわないようにしてください
- `eval()` の使用は必要最小限に抑え、入力値のバリデーションを徹底してください

## 6. 不明確な点

- 分数計算の一部で、計算式が複雑になっている箇所があります。これらの計算式の数学的背景や意図については、必要に応じて専門家に確認することをお勧めします。
- Centipedeクラスの計算式（ODD_NU, EVEN_NU など）の詳細な意味や導出過程は、ゲーム理論の専門知識が必要な場合があります。